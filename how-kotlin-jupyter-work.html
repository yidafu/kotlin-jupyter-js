<!DOCTYPE html>
<html>
<head>
  <title>docs/how-kotlin-jupyter-work.md</title>
  <link rel="stylesheet" href="theme.css">
</head>
<body><div class="markdown-body">
<h1 id="how-kotlin-jupyter-js-works-">How Kotlin Jupyter Js Works?</h1>
<blockquote>
<p>Translated with DeepL.com (free version)</p>
</blockquote>
<h2 id="motivation">Motivation</h2>
<p>I need to understand blind watermarking for work, and this involves Fourier Transforms. I don&#39;t know anything about Fourier Transforms, so I thought I&#39;d use Kotlin Jupyter to demonstrate Fourier Transforms in code step by step to aid my understanding. However, there is no library in Kotlin Jupyter to show 3D surfaces, and lets-plot seems to support only 2D charts.</p>
<p>After some trial and error, the only way to display 3D surfaces in Kotlin Jupyter is to use JS.Using JS in Kotlin Jupyter is more cumbersome. You need to convert kotlin variables to JSON strings, write the html code to be executed in the <code>HTML()</code> method, the container tag and the <code>&lt;script&gt;</code> tag.</p>
<pre><code class="lang-kotlin"><div class="highlight"><pre><span class="c1">// convert to JSON</span>
<span class="k">var</span> <span class="py">dataList</span> <span class="p">=</span> <span class="s">&quot;[&quot;</span> <span class="p">+</span> <span class="n">bList</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="s">&quot;[${it.first}, ${it.second}, ${it.third}]&quot;</span> <span class="p">}.</span><span class="n">joinToString</span><span class="p">(</span><span class="s">&quot;,\n&quot;</span><span class="p">)</span> <span class="p">+</span> <span class="s">&quot;]&quot;</span><span class="p">;</span>

<span class="c1">// render to html</span>
<span class="n">HTML</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="p">&lt;</span><span class="n">div</span> <span class="n">id</span><span class="p">=</span><span class="s">&quot;chartDom&quot;</span> <span class="n">style</span><span class="p">=</span><span class="s">&quot;width: 600px; height: 600px;&quot;</span><span class="p">&gt;</span> <span class="p">&lt;/</span><span class="n">div</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="n">script</span> <span class="k">type</span><span class="p">=</span><span class="s">&quot;module&quot;</span><span class="p">&gt;</span>
<span class="k">import</span> <span class="nn">{</span> <span class="n">init</span> <span class="p">}</span> <span class="n">from</span> <span class="s">&quot;https://unpkg.com/echarts@5.4.3/dist/echarts.esm.min.js&quot;</span>
<span class="k">import</span> <span class="nn">&quot;https://unpkg.com/echarts-gl@2.0.9/dist/echarts-gl.min.js&quot;</span>

<span class="k">var</span> <span class="py">chartDom</span> <span class="p">=</span> <span class="n">document</span><span class="p">.</span><span class="n">getElementById</span><span class="p">(</span><span class="err">&#39;</span><span class="n">chartDom</span><span class="err">&#39;</span><span class="p">);</span>
<span class="k">var</span> <span class="py">myChart</span> <span class="p">=</span> <span class="n">echarts</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">chartDom</span><span class="p">);</span>
<span class="n">myChart</span><span class="p">.</span><span class="n">setOption</span><span class="p">({</span>
  <span class="c1">// echart option</span>
<span class="p">})</span>
<span class="p">&lt;/</span><span class="n">script</span><span class="p">&gt;</span>
<span class="s">&quot;&quot;&quot;)</span>
</pre></div>

</code></pre>
<h2 id="don-t-repeat-yourself">Don&#39;t Repeat Yourself</h2>
<p>You can see that the above example has several bits of boilerplate code</p>
<ul>
<li>kotlin to Json</li>
<li>Creating the container <code>&lt;div&gt;</code> tag</li>
<li>Creating the <code>&lt;script&gt;</code> tag</li>
</ul>
<p>Like <code>ipython</code> supports <code>%js</code> to write js directly, the code with <code>%js</code> tag is intercepted before cell execution and converted to the output cell inserted by the <code>&lt;script /&gt;</code> tag.</p>
<p>At Kotlin Jupyter we also generate this stencil code through custom line magic. kotlin Jupyter already provides hooks (<a href="https://github.com/Kotlin/kotlin-jupyter/blob/master/docs/libraries.md">kotlin-jupyter/docs/libaries.md</a>) for this, all we need to do is to write a <code>CodePreprocessor</code> that intercepts the code containing <code>%js</code> and converts it to <code>HTML</code> function calls.</p>
<p>For example the following:</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="o">%</span><span class="nx">js</span>
<span class="kd">var</span> <span class="nx">hello</span> <span class="o">=</span> <span class="s2">&quot;hellow jupyter js&quot;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">hello</span><span class="p">)</span>
</pre></div>

</code></pre>
<p>It needs to be converted to</p>
<pre><code class="lang-kotlin"><div class="highlight"><pre><span class="n">HTML</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="p">&lt;</span><span class="n">script</span> <span class="k">type</span><span class="p">=</span><span class="s">&quot;module&quot;</span><span class="p">&gt;</span>
<span class="k">var</span> <span class="py">hello</span> <span class="p">=</span> <span class="s">&quot;hellow jupyter js&quot;</span>

<span class="n">console</span><span class="p">.</span><span class="n">log</span><span class="p">(</span><span class="n">hello</span><span class="p">)</span>
<span class="p">&lt;/</span><span class="n">script</span><span class="p">&gt;</span>
<span class="s">&quot;&quot;&quot;)</span>
</pre></div>

</code></pre>
<h2 id="one-more-thing">One More Thing</h2>
<p>But there&#39;s one more important thing. The purpose of writing JS in Kotlin Jupyter is to visualise Kotlin data, and just converting the code is not useful. We need to be able to use Kotlin variables in JS.</p>
<p>How can we use kotlin data in JS?</p>
<p>My idea is virtual import, defining <code>@jupyter</code> as a virtual package from which we can <code>import</code> Kotlin variables and replace them with real Kotlin variables at compile time.</p>
<p>Let&#39;s say that the first cell defines a Kotlin variable.</p>
<pre><code class="lang-kotlin"><div class="highlight"><pre><span class="k">val</span> <span class="py">foo</span> <span class="p">=</span> <span class="s">&quot;bar&quot;</span><span class="p">;</span>
</pre></div>

</code></pre>
<p>For subsequent cells, we can just import the variable and use it.</p>
<pre><code class="lang-js"><div class="highlight"><pre><span class="o">%</span><span class="nx">js</span>
<span class="kr">import</span> <span class="p">{</span> <span class="nx">foo</span> <span class="p">}</span> <span class="nx">from</span> <span class="s1">&#39;@jupyter&#39;</span><span class="p">;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;variable from kotlin&#39;</span><span class="p">,</span> <span class="nx">foo</span><span class="p">)</span>
</pre></div>

</code></pre>
<p>The actual compilation result:</p>
<pre><code class="lang-html"><div class="highlight"><pre><span class="nt">&lt;script </span><span class="na">type=</span><span class="s">&quot;module&quot;</span><span class="nt">&gt;</span>
<span class="kr">const</span> <span class="nx">foo</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span>

<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;variable from kotlin&#39;</span><span class="p">,</span> <span class="nx">foo</span><span class="p">)</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div>

</code></pre>
<p>At this point, the problem becomes the conversion of variables from the Kotlin world to the JS world. Can any Kotlin variable be converted to JSON?</p>
<p>According to the source code <a href="https://github.com/Kotlin/kotlin-jupyter/blob/94794065fd0a616b757a8cabf4574bb63344facb/jupyter-lib/api/src/main/kotlin/org/jetbrains/kotlinx/jupyter/api/VariableState.kt#L11">VariableState.kt#L11</a> we know that all Kotlin variables are saved as <code>Any</code>. Obviously we can&#39;t convert <code>Any</code> to a JSON string.</p>
<p>However, it is possible if for we can narrow down the types that support conversion to JSON.</p>
<ol>
<li>basic types /Array/Collection/Map</li>
<li>the <code>Renderable</code>/<code>DisplayResult</code> interface is used.</li>
</ol>
<p>According to the discussion in <a href="https://github.com/Kotlin/kotlinx.serialization/issues/296">Kotlin/kotlinx.serialization#296</a>, our implementation of the <code>toJsonElement</code> method in <code>Any?</code> can do the job of converting any <code>Collection</code>, <code>Map</code>, <code>Array</code>, <code>String</code>, <code>Boolean</code>, <code>Number</code> to JSON, which is sufficient for most scenarios.</p>
<p>The following function can recursively convert the base type to <code>JsonElement</code>, and then convert <code>JsonElement</code> to a string is very convenient.</p>
<pre><code class="lang-kotlin"><div class="highlight"><pre><span class="k">fun</span> <span class="nf">Any</span><span class="o">?.</span><span class="n">toJsonElement</span><span class="p">():</span> <span class="n">JsonElement</span> <span class="p">=</span> <span class="k">when</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">null</span> <span class="p">-&gt;</span> <span class="n">JsonNull</span>
    <span class="k">is</span> <span class="n">Collection</span><span class="p">&lt;*&gt;</span> <span class="p">-&gt;</span> <span class="n">toJsonElement</span><span class="p">()</span> <span class="c1">// call Collection&lt;*&gt;.toJsonElement()</span>
    <span class="k">is</span> <span class="n">String</span> <span class="p">-&gt;</span> <span class="n">JsonPrimitive</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="c1">// end of recursive</span>
    <span class="c1">// ... ignore Map&lt;*, *&gt; Array&lt;*&gt;, other primary type</span>
    <span class="k">else</span> <span class="p">-&gt;</span> <span class="p">{</span>
      <span class="k">throw</span> <span class="n">IllegalStateException</span><span class="p">(</span><span class="s">&quot;Can&#39;t serialize unknown type: $this&quot;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">fun</span> <span class="nf">Collection</span><span class="p">&lt;*&gt;.</span><span class="n">toJsonElement</span><span class="p">():</span> <span class="n">JsonElement</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">JsonArray</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span>
      <span class="n">it</span><span class="p">.</span><span class="n">toJsonElement</span><span class="p">()</span> <span class="c1">// recursively transform value to JsonElement </span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<p>Full code: <a href="https://github.com/yidafu/kotlin-jupyter-js/blob/50fb7d30cc15d9554e5062986aafe06922470fbf/jupyter-js/src/main/kotlin/dev/yidafu/jupyper/AnyToJsonElement.kt#L5">AnyToJsonElement.kt#L5</a></p>
<p>However, this way does not support classes, and for class support you need another way. Implement the <code>DisplayResult</code> or <code>Renderable</code> interface. Because <code>DisplayResult</code> has <code>toJSon</code> method, through this method can get the json object which can be imported.</p>
<pre><code class="lang-kotlin"><div class="highlight"><pre><span class="k">when</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">is</span> <span class="n">DisplayResult</span> <span class="p">-&gt;</span> <span class="p">{</span>
    <span class="n">value</span><span class="p">.</span><span class="n">toJson</span><span class="p">()</span>
  <span class="p">}</span>
  <span class="k">is</span> <span class="n">Renderable</span> <span class="p">-&gt;</span> <span class="p">{</span>
    <span class="n">value</span><span class="p">.</span><span class="n">render</span><span class="p">(</span><span class="n">notebook</span><span class="p">).</span><span class="n">toJson</span><span class="p">()</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>

</code></pre>
<h2 id="from-javascript-to-javascript">From JavaScript To JavaScript</h2>
<p>The virtual import mentioned above requires that the import statement be able to be compiled into a variable declaration. We can replace the import statement with a variable declaration using regular expressions, but this is not a good way to handle the source code. It would be better to convert the JS code to an AST, which we manipulate to transform the code.</p>
<p>However, Kotlin doesn&#39;t have a good tool for compiling JS, and common JS compilers such as babel are written in JS, making them difficult to use in the JVM. However, thanks to the rustification of the front-end toolchain in the last few years. Some JS compilers written in Rust such as <code>SWC</code>, <code>OXC</code>, and so on, are now available. Now, kotlin can call SWC via <code>JNI</code> to compile JS source code. Kotlin can also support <code>JS</code> compilation &#39;natively&#39;.</p>
<p>However, the community doesn&#39;t seem to have an existing <code>swc</code> binding, but it&#39;s easier to write a binding than a JS compiler.</p>
<p>I have implemented a SWC binding  <a href="https://central.sonatype.com/artifact/dev.yidafu.swc/swc-binding">swc-binding</a>.</p>
<p>With SWC, we can support not only <code>js</code>, but also <code>ts</code>/<code>jsx</code>/<code>tsx</code>.</p>
<p>Refer to the flowchart below:</p>
<p><a href="https://mermaid.live/edit#pako:eNp9Ut9r20AM_lfEPceGrdsKoeyh7KGwFQYtDBr34Xonx5f4TkanWwgh__sUe0uTNsxgkHT6Pv36dsaRRzM3TWp72rjOssDtY5NAv1umTUY-c6CqPtSQqbBDOGCr6it8J-lDmvImW9Oua-gk9sCYSy-HtHPCXF6WbIfuL2KxnoCrMmxF66yRE_bPU-5IPAZe_Z9MDnMmfotcZRgYh3_PJxR54xb6w-p3hJeQfEjLdwW08481eBR0cjondDYfqKNdBgfEkGgc6thGky70BjdVBVc1CNuUW-I4cs10KVI4gc2iTzguURu7RKD4TzVE8qHdnuWfFL5c9nOtewhJjigQggfR0PK_9b7U8EsPM0yrHGffBOng7vH-B7QlOQmUxrOfXASTnwwzMxE52uBVVbtDrDHSYcTGzNX02FqVQ6OC22uqLUIP2-TMXLjgzJTBW8Fvwao0opm3ts8aHWx6Inr10Qchvp-UOwp4_wdJ4ue5"><img src="https://mermaid.ink/img/pako:eNp9Ut9r20AM_lfEPceGrdsKoeyh7KGwFQYtDBr34Xonx5f4TkanWwgh__sUe0uTNsxgkHT6Pv36dsaRRzM3TWp72rjOssDtY5NAv1umTUY-c6CqPtSQqbBDOGCr6it8J-lDmvImW9Oua-gk9sCYSy-HtHPCXF6WbIfuL2KxnoCrMmxF66yRE_bPU-5IPAZe_Z9MDnMmfotcZRgYh3_PJxR54xb6w-p3hJeQfEjLdwW08481eBR0cjondDYfqKNdBgfEkGgc6thGky70BjdVBVc1CNuUW-I4cs10KVI4gc2iTzguURu7RKD4TzVE8qHdnuWfFL5c9nOtewhJjigQggfR0PK_9b7U8EsPM0yrHGffBOng7vH-B7QlOQmUxrOfXASTnwwzMxE52uBVVbtDrDHSYcTGzNX02FqVQ6OC22uqLUIP2-TMXLjgzJTBW8Fvwao0opm3ts8aHWx6Inr10Qchvp-UOwp4_wdJ4ue5?type=png" alt=""></a></p>
<p>If the code given to the Kotlin Kernel contains <code>%js</code> magic, <code>JavaScriptMagicCodeProcessor</code> will process the JS code into legal kotlin code.</p>
<p>The <code>JavaScriptMagicCodeProcessor</code> process is as follows</p>
<p>The first step is to convert <code>jsx</code>/<code>ts</code>/<code>tsx</code> to normal JS, if it is JS, it will not be processed.</p>
<p>The second step is to manipulate the AST</p>
<ol>
<li>change <code>import { * } from &#39;@jupyter&#39;;</code> to variable declaration statement</li>
<li>change the default export of <code>jsx</code>/<code>tsx</code> to variable declaration.</li>
<li>other operations</li>
</ol>
<p>Step 3, print AST to code</p>
<p>Finally, the JS code is wrapped in HTML and returned as a result.</p>
<h2 id="epilogue">Epilogue</h2>
<p>At this point, the idea of kotlin Jupyter supporting <code>%js</code> magic is sorted out.</p>
<p>Below is Screenshot of an example from Echarts:</p>
<p><img src="./echars-example.png" alt=""></p>
<p>For an actual example, take a look at <a href="https://github.com/yidafu/kotlin-jupyter-js/blob/main/examples/js-magic.ipynb">examples/js-magic.ipynb</a></p>
<p>Feel free to try it out and give feedback on issues.</p>
<script src="prism.js" ></script></div></body>
</html>
